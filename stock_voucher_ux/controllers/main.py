# Copyright 2017 ACSONE SA/NV
# Copyright 2018 - Brain-tec AG - Carlos Jesus Cebrian
# License AGPL-3.0 or later (http://www.gnu.org/licenses/agpl)
import io
import json
import urllib.parse
import re

from odoo.http import route, request
from odoo.addons.web.controllers import report
from PyPDF2 import PdfFileReader


class ReportController(report.ReportController):

    @route()
    def report_download(self, data, context=None):
        """This function is used by 'qwebactionmanager.js' in order to trigger
        the download of a py3o/controller report.
        :param data: a javascript array JSON.stringified containg report
        internal url ([0]) and type [1]
        :returns: Response with a filetoken cookie and an attachment header
        """
        response = super().report_download(data, context)
        #NTH detect if the binary is a PDF, no matter ifn it was generated by a QWeb or Aeroo
        requestcontent = json.loads(data)
        url, type = requestcontent[0], requestcontent[1]
        if type == 'aeroo' and 'remito' in url:
            context_part = json.loads(data)[0].split('context=')[1]
            context_dict = json.loads(urllib.parse.unquote(context_part))
            picking_id  = context_dict.get('active_ids')
            assign  = context_dict.get('assign')
            book_id = request.env['stock.picking'].browse(picking_id).book_id
            if assign and book_id and picking_id:
                pdf_response = response.response[0]
                reader = PdfFileReader(io.BytesIO(pdf_response))
                # The number of pages will assign the number of vouchers
                number_pages = len(reader.pages)

                # See if there are vouchers already assigned. If not, then it assigns the vouchers
                if not request.env['stock.picking'].browse(picking_id).voucher_ids and book_id:
                    request.env['stock.picking'].browse(picking_id).assign_numbers(number_pages, book_id)

        elif 'report_deliveryslip' in url:
            # If the report is not an aeroo, the assign method should only assign one voucher
            match = re.search(r'(\d+)$', json.loads(data)[0])
            if match:
                picking_id = int(match.group(1))
                book_id = request.env['stock.picking'].browse(picking_id).book_id
                if book_id and book_id.autoprinted == False and picking_id:
                    pdf_response = response.response[0]
                    reader = PdfFileReader(io.BytesIO(pdf_response))
                    # The number of pages will assign the number of vouchers
                    number_pages = len(reader.pages)

                    if not request.env['stock.picking'].browse(picking_id).voucher_ids and book_id:
                        request.env['stock.picking'].browse(picking_id).assign_numbers(number_pages, book_id)

                elif book_id and picking_id:
                    if not request.env['stock.picking'].browse(picking_id).voucher_ids and book_id:
                        request.env['stock.picking'].browse(picking_id).assign_numbers(1, book_id)

        return response
